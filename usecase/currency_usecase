package usecase

import (
	"context"
	"errors"

	"github.com/lucky777strike/bottest/domain"
	"github.com/lucky777strike/bottest/utils/currency"
)

type CurrencyService struct {
	tool *currency.CurrencyService
	repo domain.CurrencyRepository
}

func NewCurrencyUsecase(repo domain.CurrencyRepository) domain.CurrencyUsecase {
	return &CurrencyService{tool: currency.New(), repo: repo}
}

func (c *CurrencyService) GetCurrency(ctx context.Context, name string) (*domain.Currency, error) {
	cur, err := c.repo.GetCurrency(ctx, name)
	if err != nil {
		if errors.Is(err, domain.ErrNoCurrencyInBase) {
			cur, err = c.UpdateCurrencyFromAPI(ctx, name)
			if err != nil {
				return nil, err
			}
		} else {
			return nil, err
		}
	}

	return &cur, nil
}

func (c *CurrencyService) SetCurrency(ctx context.Context, name string, value string) error {
	curValue, err := c.tool.ParseCurrencyValue(value)
	if err != nil {
		return err
	}

	cur := domain.Currency{
		Name:    name,
		Value:   curValue,
		LastUpd: time.Now(),
	}

	return c.repo.SetCurrency(ctx, cur)
}

func (c *CurrencyService) UpdateCurrency(ctx context.Context, name string, value string) error {
	curValue, err := c.tool.ParseCurrencyValue(value)
	if err != nil {
		return err
	}

	cur := domain.Currency{
		Name:    name,
		Value:   curValue,
		LastUpd: time.Now(),
	}

	return c.repo.UpdateCurrency(ctx, cur)
}

func (c *CurrencyService) UpdateCurrencyFromAPI(ctx context.Context, name string) (domain.Currency, error) {
	curValue, err := c.tool.GetCurrency(ctx, name)
	if err != nil {
		return domain.Currency{}, err
	}

	cur := domain.Currency{
		Name:    name,
		Value:   curValue,
		LastUpd: time.Now(),
	}

	err = c.repo.SetCurrency(ctx, cur)
	if err != nil {
		return domain.Currency{}, err
	}

	return cur, nil
}

func (c *CurrencyService) AvailableCurrencies() []string {
	return c.tool.AvailableCurrencies()
}
